name: Deploy Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Environment to deploy (prod, dev, staging)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Determine Environment
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENV="${{ github.event.inputs.environment }}"
        else
          ENV="prod"
        fi
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ Deploying to: $ENV"

    - name: Build & Deploy Unified API
      run: |
        set -e
        ENV="${{ steps.env.outputs.environment }}"
        RG="vermillion-${ENV}-rg"
        PROJECT_PATH="backend/Vermillion.API"
        APP_ID="vermillion-api"
        OUT_DIR="${{ env.DOTNET_ROOT }}/myapp-api"

        echo "\n=== Building Vermillion.API (path=$PROJECT_PATH) ==="
        dotnet restore "$PROJECT_PATH"
        dotnet build "$PROJECT_PATH" --configuration Release --no-restore
        dotnet publish "$PROJECT_PATH" -c Release -o "$OUT_DIR"

        # Create zip artifact
        ZIP_PATH="$PWD/${APP_ID}.zip"
        if ! command -v zip >/dev/null 2>&1; then
          echo "zip not found, installing..."
          sudo apt-get update -y
          sudo apt-get install -y zip
        fi
        (cd "$OUT_DIR" && zip -r "$ZIP_PATH" .)

        WEBAPP_NAME="vermillion-api-${ENV}"

        echo "Prepared artifact for Vermillion.API -> $ZIP_PATH; target webapp: $WEBAPP_NAME"

        # Verify web app exists before deploying
        set +e
        az webapp show --name "$WEBAPP_NAME" --resource-group "$RG" >/dev/null 2>&1
        APP_EXISTS=$?
        set -e

        if [ $APP_EXISTS -ne 0 ]; then
          echo "\nâ— Target web app '$WEBAPP_NAME' not found in resource group $RG."
          echo "Hint: Run the 'Setup Azure Infrastructure' workflow to provision the web app, or create it manually in the portal."
          exit 2
        fi

        # Configure app settings BEFORE deployment
        if [ "$ENV" = "prod" ]; then
          echo "Configuring production environment settings..."
          az webapp config appsettings set \
            --name "$WEBAPP_NAME" \
            --resource-group "$RG" \
            --settings RUN_MIGRATIONS=false ASPNETCORE_ENVIRONMENT=Production
        else
          echo "Configuring $ENV environment settings..."
          az webapp config appsettings set \
            --name "$WEBAPP_NAME" \
            --resource-group "$RG" \
            --settings RUN_MIGRATIONS=true ASPNETCORE_ENVIRONMENT=Development
        fi

        echo "Starting async deployment to $WEBAPP_NAME..."
        az webapp deploy --resource-group "$RG" --name "$WEBAPP_NAME" --src-path "$ZIP_PATH" --async
        echo "Deployment initiated, health check will verify readiness..."

    - name: ğŸ” Health check API
      run: |
        set -e
        ENV="${{ steps.env.outputs.environment }}"
        WEBAPP_NAME="vermillion-api-${ENV}"
        URL="https://${WEBAPP_NAME}.azurewebsites.net/health"

        echo "Checking API health at: $URL"

        ATTEMPTS=12
        SLEEP_SECONDS=5
        for i in $(seq 1 $ATTEMPTS); do
          if curl -s -f -S "$URL" >/dev/null 2>&1; then
            echo "âœ… Health check passed on attempt $i"
            exit 0
          fi
          echo "Attempt $i/$ATTEMPTS failed â€” waiting $SLEEP_SECONDS seconds before retrying..."
          sleep $SLEEP_SECONDS
        done

        echo "âŒ Health check failed after $ATTEMPTS attempts; aborting workflow."
        exit 1

    - name: âœ… Deployment Complete
      run: |
        ENV="${{ steps.env.outputs.environment }}"
        WEBAPP_NAME="vermillion-api-${ENV}"
        echo "âœ… Backend deployed successfully!"
        echo "ğŸ¯ Environment: $ENV"
        echo "ğŸ”§ Deployed API: https://${WEBAPP_NAME}.azurewebsites.net"
