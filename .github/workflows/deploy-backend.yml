name: Deploy Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Environment to deploy (prod, dev, staging)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout code
      uses: actions/checkout@v4
    
    - name: üîß Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üîê Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Determine Environment
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENV="${{ github.event.inputs.environment }}"
        else
          ENV="prod"
        fi
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        echo "üìå Deploying to: $ENV"

    - name: Build & Deploy Unified API
      run: |
        set -e
        ENV="${{ steps.env.outputs.environment }}"
        RG="vermillion-${ENV}-rg"
        PROJECT_PATH="backend/Vermillion.API"
        APP_ID="vermillion-api"
        OUT_DIR="${{ env.DOTNET_ROOT }}/myapp-api"

        echo "\n=== Building Vermillion.API (path=$PROJECT_PATH) ==="
        dotnet restore "$PROJECT_PATH"
        dotnet build "$PROJECT_PATH" --configuration Release --no-restore
        dotnet publish "$PROJECT_PATH" -c Release -o "$OUT_DIR"

        # Create zip artifact
        ZIP_PATH="$PWD/${APP_ID}.zip"
        if ! command -v zip >/dev/null 2>&1; then
          echo "zip not found, installing..."
          sudo apt-get update -y
          sudo apt-get install -y zip
        fi
        (cd "$OUT_DIR" && zip -r "$ZIP_PATH" .)

        WEBAPP_NAME="vermillion-api-${ENV}"

        echo "Prepared artifact for Vermillion.API -> $ZIP_PATH; target webapp: $WEBAPP_NAME"

        # Verify web app exists before deploying
        set +e
        az webapp show --name "$WEBAPP_NAME" --resource-group "$RG" >/dev/null 2>&1
        APP_EXISTS=$?
        set -e

        if [ $APP_EXISTS -ne 0 ]; then
          echo "\n‚ùó Target web app '$WEBAPP_NAME' not found in resource group $RG."
          echo "Hint: Run the 'Setup Azure Infrastructure' workflow to provision the web app, or create it manually in the portal."
          exit 2
        fi

        # Configure app settings BEFORE deployment
        if [ "$ENV" = "prod" ]; then
          echo "Configuring production environment settings..."
          az webapp config appsettings set \
            --name "$WEBAPP_NAME" \
            --resource-group "$RG" \
            --settings RUN_MIGRATIONS=false ASPNETCORE_ENVIRONMENT=Production
        else
          echo "Configuring $ENV environment settings..."
          az webapp config appsettings set \
            --name "$WEBAPP_NAME" \
            --resource-group "$RG" \
            --settings RUN_MIGRATIONS=true ASPNETCORE_ENVIRONMENT=Development
        fi

        az webapp deploy --resource-group "$RG" --name "$WEBAPP_NAME" --src-path "$ZIP_PATH"

    - name: ‚úÖ Deployment Complete
      run: |
        echo "‚úÖ Backend deployed successfully!"
        echo "üéØ Environment: ${{ steps.env.outputs.environment }}"
        echo "Deployed web apps: attendance-api, auth-api, entryexit-api (names suffixed with environment)"
