name: Deploy Backend to Azure

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      environment:
        description: 'Environment to deploy (prod, dev, staging)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸŽ¯ Determine Environment
      id: env
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENV="${{ github.event.inputs.environment }}"
        else
          ENV="prod"
        fi
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        echo "ðŸ“Œ Deploying to: $ENV"

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ï¿½ Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ðŸ“¦ Setup build output dir
      run: mkdir -p ${{ env.DOTNET_ROOT }}

    - name: ðŸ” Build & Publish Backends
      run: |
        set -e
        ENV="${{ steps.env.outputs.environment }}"
        RG="vermillion-attendance-${ENV}-rg"

        # Define backend projects and corresponding app ids (used in webapp naming)
        PROJECTS=("AttendanceAPI" "AuthAPI" "EntryExitAPI")
        APP_IDS=("attendance-api" "auth-api" "entryexit-api")

        for i in "${!PROJECTS[@]}"; do
          PROJ=${PROJECTS[$i]}
          APP_ID=${APP_IDS[$i]}
          PROJECT_PATH="backend/$PROJ"
          OUT_DIR="${{ env.DOTNET_ROOT }}/myapp-$APP_ID"

          echo "\n=== Building $PROJ (path=$PROJECT_PATH) ==="
          dotnet restore "$PROJECT_PATH"
          dotnet build "$PROJECT_PATH" --configuration Release --no-restore
          dotnet publish "$PROJECT_PATH" -c Release -o "$OUT_DIR"

          # Create zip artifact
          ZIP_PATH="$PWD/${APP_ID}.zip"
          if ! command -v zip >/dev/null 2>&1; then
            echo "zip not found, installing..."
            sudo apt-get update -y
            sudo apt-get install -y zip
          fi
          (cd "$OUT_DIR" && zip -r "$ZIP_PATH" .)

          # Determine webapp name
          WEBAPP_NAME="vermillion-${APP_ID}-${ENV}"

          echo "Prepared artifact for $PROJ -> $ZIP_PATH; target webapp: $WEBAPP_NAME"

          # Deploy
          echo "Deploying $ZIP_PATH to $WEBAPP_NAME in resource group $RG"
          az webapp deploy --resource-group "$RG" --name "$WEBAPP_NAME" --src-path "$ZIP_PATH"
        done

    - name: âœ… Deployment Complete
      run: |
        echo "âœ… Backend deployed successfully!"
        echo "ðŸŽ¯ Environment: ${{ steps.env.outputs.environment }}"
        echo "Deployed web apps: attendance-api, auth-api, entryexit-api (names suffixed with environment)"
