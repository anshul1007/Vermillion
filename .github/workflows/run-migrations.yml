name: Run Database Migrations and Seeders

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Environment to run migrations on'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging
      run_seeders:
        description: 'Run seeders after migrations'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      backends:
        description: 'Backends to migrate (comma-separated: attendance,auth,entryexit or "all")'
        required: true
        default: 'all'
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  SQL_SERVER_NAME: vermillion-sql-${{ github.event.inputs.environment }}

jobs:
  run-migrations:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ Checkout code
      uses: actions/checkout@v4

    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ðŸ“¦ Install EF Core Tools
      run: |
        echo "## dotnet info"
        dotnet --info

        echo "Installing dotnet-ef (v8) to match SDK..."
        dotnet tool install --global dotnet-ef --version 8.*
        echo "## Ensure dotnet tools are on PATH"
        export PATH="$HOME/.dotnet/tools:$PATH"

    - name: ðŸ” Restore & Build solution
      run: |
        echo "Restoring and building solution at backend/Vermillion.sln..."
        dotnet restore backend/Vermillion.sln
        dotnet build backend/Vermillion.sln --configuration Release
        echo "Build complete."

    - name: ðŸ” Determine migration target
      id: determine_backends
      run: |
        echo "backends=vermillion" >> $GITHUB_OUTPUT

    - name: ðŸ—„ï¸ Run Migrations for domain projects (Auth, Attendance, EntryExit, Shared)
      env:
        ConnectionStrings__DefaultConnection: Server=tcp:${{ env.SQL_SERVER_NAME }}.database.windows.net,1433;Initial Catalog=VermillionDB_${{ github.event.inputs.environment }};User ID=${{ vars.SQL_ADMIN_USER || 'sqladmin' }};Password=${{ secrets.SQL_ADMIN_PASSWORD_PROD }};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;ConnectRetryCount=3;ConnectRetryInterval=10;
      run: |
        echo "Running EF migrations for domain projects against VermillionDB_${{ github.event.inputs.environment }}"

        STARTUP_PROJECT="backend/Vermillion.API"

        echo "-- Applying Auth domain migrations"
        dotnet ef database update --project backend/Vermillion.Auth.Domain --startup-project $STARTUP_PROJECT --context AuthDbContext

        echo "-- Applying Attendance domain migrations"
        dotnet ef database update --project backend/Vermillion.Attendance.Domain --startup-project $STARTUP_PROJECT --context AttendanceDbContext

        echo "-- Applying EntryExit domain migrations"
        dotnet ef database update --project backend/Vermillion.EntryExit.Domain --startup-project $STARTUP_PROJECT --context EntryExitDbContext

        echo "-- Applying Shared domain migrations"
        dotnet ef database update --project backend/Vermillion.Shared.Domain --startup-project $STARTUP_PROJECT --context SharedDbContext

        echo "âœ… All domain migrations applied"

    - name: ðŸŒ± Run Seeder for Unified API
      if: github.event.inputs.run_seeders == 'true'
      run: |
        echo "Running seeder for Vermillion.API..."
        cd backend/Vermillion.API
        
        # Build the API first
        dotnet build --configuration Release
        
        # Run the API with seeding enabled
        export ConnectionStrings__DefaultConnection="Server=tcp:${{ env.SQL_SERVER_NAME }}.database.windows.net,1433;Initial Catalog=VermillionDB_${{ github.event.inputs.environment }};User ID=${{ vars.SQL_ADMIN_USER || 'sqladmin' }};Password=${{ secrets.SQL_ADMIN_PASSWORD_PROD }};Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;ConnectRetryCount=3;ConnectRetryInterval=10;"
        export SeedOnStartup=true
        export RUN_MIGRATIONS=false
        
        # Start the API in background, wait for seeding, then stop
        timeout 60s dotnet run --configuration Release --no-build || true
        
        echo "âœ… Vermillion.API seeder completed"

    - name: ðŸ“ Summary
      if: always()
      run: |
        echo "## Migration & Seeder Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Backends**: ${{ steps.determine_backends.outputs.backends }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Seeders**: ${{ github.event.inputs.run_seeders }}" >> $GITHUB_STEP_SUMMARY
        echo "- **SQL Server**: ${{ env.SQL_SERVER_NAME }}.database.windows.net" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check the logs above for detailed results." >> $GITHUB_STEP_SUMMARY
